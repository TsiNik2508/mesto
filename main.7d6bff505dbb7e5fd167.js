(()=>{"use strict";const t=class{constructor(t,e){this._config=t,this._formElement=e,this._inputList=Array.from(this._formElement.querySelectorAll(this._config.inputSelector)),this._submitButton=this._formElement.querySelector(this._config.submitButtonSelector)}_showInputError(t,e){const s=t.nextElementSibling;s.textContent=e,s.classList.add(this._config.errorClass),t.classList.add(this._config.inputErrorClass)}_hideInputError(t){const e=t.nextElementSibling;e.textContent="",e.classList.remove(this._config.errorClass),t.classList.remove(this._config.inputErrorClass)}_checkInputValidity(t){if(t.validity.valid)this._hideInputError(t);else{const e=t.validationMessage;this._showInputError(t,e)}}toggleButtonState(){this._hasInvalidInput()?(this._submitButton.disabled=!0,this._submitButton.classList.add(this._config.inactiveButtonClass)):(this._submitButton.disabled=!1,this._submitButton.classList.remove(this._config.inactiveButtonClass))}_hasInvalidInput(){return this._inputList.some((t=>!t.validity.valid))}_setEventListeners(){this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._checkInputValidity(t),this.toggleButtonState()}))}))}enableValidation(){this._setEventListeners(),this.toggleButtonState()}resetValidation(){this._inputList.forEach((t=>{this._hideInputError(t)})),this.toggleButtonState()}};const e=class{constructor(t){this._popup=document.querySelector(t),this._handleEscClose=this._handleEscClose.bind(this)}setCardId(t){this._cardId=t}_handleEscClose(t){"Escape"===t.key&&this.close()}open(t){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose),this.setCardId(t)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popup.addEventListener("click",(t=>{(t.target.classList.contains("popup")||t.target.classList.contains("popup__close"))&&this.close()}))}};const s=class extends e{constructor(t){super(t),this._popupImage=this._popup.querySelector(".popup__img"),this._popupCaption=this._popup.querySelector(".popup__card-name"),this._cardId=null}setCardId(t){this._cardId=t}open(t){this._popupImage.src=t.link,this._popupImage.alt=t.name,this._popupCaption.textContent=t.name,super.open()}};const n=class extends e{constructor(t,e){super(t),this._submitHandler=e,this._form=this._popup.querySelector(".popup__form"),this._inputs=Array.from(this._form.querySelectorAll(".popup__input")),this._submitButton=this._form.querySelector(".popup__button")}_getInputValues(){const t={};return this._inputs.forEach((e=>{t[e.name]=e.value})),t}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this._submitHandler(this._getInputValues())}))}open(){super.open(),this._submitButton.textContent="Сохранение..."}setSubmitButtonCaption(t){this._submitButton.textContent=t}close(){super.close(),this._form.reset()}};const o=class{constructor(t){let{nameSelector:e,bioSelector:s}=t;this._nameElement=document.querySelector(e),this._bioElement=document.querySelector(s),this._id=null}getUserInfo(){return{name:this._nameElement.textContent,bio:this._bioElement.textContent}}setUserInfo(t){this._nameElement.textContent=t.name,this._bioElement.textContent=t.about,this._id=t._id}getUserId(){return this._id}};const i=class{constructor(t,e){let{renderer:s}=t;this._renderer=s,this._container=document.querySelector(e),this._items=[]}renderItems(t){t.forEach((t=>{this._renderer(t)}))}addItem(t){this._container.prepend(t)}removeItem(t){const e=this._container.querySelector('[data-card-id="'.concat(t,'"]'));e&&e.remove()}updateLikes(t,e){this._items.forEach((s=>{s._data._id===t&&s.updateLikes(e)}))}setItems(t){this._items=t}};const r=class{constructor(t){this.baseUrl=t.baseUrl,this.headers=t.headers}_checkResponse(t){return t.ok?t.json():Promise.reject("Ошибка: ".concat(t.status))}getUserInfo(){return fetch("".concat(this.baseUrl,"/users/me"),{headers:{authorization:this.headers.authorization,"Content-Type":this.headers["Content-Type"],cohort:"cohort-75"}}).then(this._checkResponse)}getInitialCards(){return fetch("".concat(this.baseUrl,"/cards"),{headers:this.headers}).then(this._checkResponse)}editUserInfo(t){return fetch("".concat(this.baseUrl,"/users/me"),{method:"PATCH",headers:this.headers,body:JSON.stringify(t)}).then(this._checkResponse)}addCard(t){let{name:e,link:s}=t;return fetch("".concat(this.baseUrl,"/cards"),{method:"POST",headers:this.headers,body:JSON.stringify({name:e,link:s})}).then(this._checkResponse)}deleteCard(t){return console.log("Deleting card with ID:",t),fetch("".concat(this.baseUrl,"/cards/").concat(t),{method:"DELETE",headers:this.headers}).then(this._checkResponse)}likeCard(t){return fetch("".concat(this.baseUrl,"/cards/likes/").concat(t),{method:"PUT",headers:this.headers}).then(this._checkResponse)}unlikeCard(t){return fetch("".concat(this.baseUrl,"/cards/likes/").concat(t),{method:"DELETE",headers:this.headers}).then(this._checkResponse)}updateAvatar(t){return fetch("".concat(this.baseUrl,"/users/me/avatar"),{method:"PATCH",headers:{authorization:this.headers.authorization,"Content-Type":this.headers["Content-Type"]},body:JSON.stringify({avatar:t})}).then(this._checkResponse).catch((t=>{console.error("Ошибка при обновлении аватара: ".concat(t))}))}toggleLike(t,e){const s=e?"PUT":"DELETE",n="".concat(this.baseUrl,"/cards/likes/").concat(t);return fetch(n,{method:s,headers:this.headers}).then((t=>{if(t.ok)return t.json();throw new Error("Ошибка: ".concat(t.status))})).catch((t=>{console.error("Ошибка при обновлении лайка: ".concat(t))}))}};const a=class extends e{constructor(t,e){super(t),this._handleFormSubmit=e,this._form=this._popup.querySelector(".popup__form"),this._submitButton=this._form.querySelector(".popup__button"),this._cardId=null}setCardId(t){this._cardId=t}setEventListeners(){super.setEventListeners(),this._popup.querySelector(".popup__close").addEventListener("click",(()=>{console.log("Close button clicked"),this.close()})),this._form.addEventListener("submit",(t=>{t.preventDefault(),console.log("Form submitted"),this._handleFormSubmit()}))}open(t){this.setCardId(t),super.open()}};const c=class extends e{constructor(t,e,s){super(t),this._handleAvatarUpdate=e,this._form=this._popup.querySelector(".popup__form_type-avatar"),this._avatarInput=this._form.querySelector(".popup__input_type_avatar"),this._api=s}_getInputValues(){return{avatar:this._avatarInput.value}}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault();const e=this._getInputValues();this._api.updateAvatar(e.avatar).then((t=>{this._handleAvatarUpdate(t.avatar),this.close()})).catch((t=>{console.error("Ошибка при обновлении аватара: ".concat(t))}))}))}open(){super.open(),this._avatarInput.value=""}close(){super.close(),this._form.reset()}};function l(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||null===t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const u=class{constructor(t,e,s,n,o,i,r,a,c){l(this,"_handleLikeButtonClick",(()=>{const t=this._likeButton.classList.contains("element__button_active"),e=this._data._id;t?this._handleUnlikeCard(e):this._handleLikeCard(this)})),l(this,"_handleDeleteButtonClick",(()=>{this._handleDeleteClick(this._data._id),this._cardElement.remove(),this._cardElement=null})),l(this,"_handleImageClick",(()=>{this._handleCardClick(this._data)})),this._data=t,this._templateSelector=e,this._handleCardClick=s,this._element=this._getTemplate(),this._likeButton=this._element.querySelector(".element__button"),this._deleteButton=this._element.querySelector(".element__thrash-button"),this._cardImage=this._element.querySelector(".element__img"),this._likeCount=this._element.querySelector(".element__like-count"),this._handleDeleteClick=i,this._isOwner=r,this._cardElement=this._element,this._handleLikeCard=n,this._handleUnlikeCard=o,this._isLiked=a,this._userid=c,this._setEventListeners()}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".element").cloneNode(!0)}_setEventListeners(){this._likeButton.addEventListener("click",this._handleLikeButtonClick),this._deleteButton.addEventListener("click",this._handleDeleteButtonClick),this._cardImage.addEventListener("click",this._handleImageClick)}generateCard(){const{name:t,link:e}=this._data;return this._cardImage.src=e,this._cardImage.alt=t,this._element.querySelector(".element__title").textContent=t,this._likeCount.textContent=this._data.likes.length,this._isOwner?this._deleteButton.classList.add("visible"):this._deleteButton.classList.remove("visible"),this.updateLikeButtonState(),this._element}updateLikes(t){Array.isArray(t)?(this._likeCount.textContent=t.length,this._isLiked=t.some((t=>t._id===this._userid))):(this._likeCount.textContent=0,this._isLiked=!1)}updateLikeButtonState(){this._isLiked?this._likeButton.classList.add("element__button_active"):this._likeButton.classList.remove("element__button_active")}};let h;const _=new r({baseUrl:"https://nomoreparties.co/v1/cohort-75",headers:{authorization:"15456b01-b272-4795-9fed-b0870e9982e9","Content-Type":"application/json"}}),p=document.querySelector(".profile__edit-button"),d=document.querySelector(".profile__add-button"),m=document.querySelector(".popup__form_edit"),v=document.querySelector(".popup__form_add"),b=(document.querySelector(".elements"),document.querySelector(".popup__form_type-avatar")),f=new s(".popup_type-card");f.setEventListeners();const C=new t({inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},b),k=new t({inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},v),y=new n(".popup_type-add",(t=>{_.getUserInfo().then((t=>(h=t._id,E.setUserInfo(t),_.getInitialCards()))).then((t=>{g.setItems(t),g.renderItems(t)})).catch((t=>{console.error("Ошибка при загрузке данных с сервера: ".concat(t))})),y.close()}));y.setEventListeners();const E=new o({nameSelector:".profile__title",bioSelector:".profile__bio"});function L(t){if(!t)return void console.error("Неверный cardId");const e=new a(".popup_type-delete",(()=>{_.deleteCard(t).then((()=>{g.removeItem(t),e.close()})).catch((t=>{console.error("Ошибка при удалении карточки: ".concat(t))}))}));e.setEventListeners(),e.open()}const S=new t({inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},m);d.addEventListener("click",(()=>{k.resetValidation(),y.open()}));const g=new i({items:[],renderer:t=>{const e=function(t){const e=t.owner&&t.owner._id===h,s=!!t.likes&&t.likes.some((t=>t._id===h));return new u(t,"#card-template",U,w,x,L,e,s,h).generateCard()}(t);g.addItem(e)}},".elements");_.getUserInfo().then((t=>(h=t._id,E.setUserInfo(t),_.getInitialCards()))).then((t=>{g.renderItems(t)})).catch((t=>{console.error("Ошибка при загрузке данных с сервера: ".concat(t))}));const I=m.querySelector(".popup__input_type_name"),B=m.querySelector(".popup__input_type_bio"),q=new n(".popup_type-edit",(t=>{!function(t){q.setSubmitButtonCaption("Сохранение..."),_.editUserInfo(t).then((t=>{E.setUserInfo(t),q.close()})).catch((t=>{console.error("Ошибка при редактировании профиля: ".concat(t))})).finally((()=>{q.setSubmitButtonCaption("Сохранить")}))}(t),q.close()}));function U(t){f.open(t)}function w(t){_.likeCard(t._data._id).then((e=>{console.log("Новые лайки:",e),t.updateLikes(e)})).catch((t=>{console.error("Ошибка при постановке лайка: ".concat(t))}))}function x(t){_.unlikeCard(t).then((e=>{g.updateLikes(t,e)})).catch((t=>{console.error("Ошибка при удалении лайка: ".concat(t))}))}q.setEventListeners(),S.enableValidation(),k.enableValidation(),C.enableValidation(),p.addEventListener("click",(()=>{!function(){const t=E.getUserInfo();I.value=t.name,B.value=t.bio,q.open()}(),q.setSubmitButtonCaption("Сохранить")})),d.addEventListener("click",(()=>y.open()));const T=new a(".popup_type-delete",(t=>{_.deleteCard(t).then((()=>{g.removeItem(t),T.close()})).catch((t=>{console.error("Ошибка при удалении карточки: ".concat(t))}))}));T.setEventListeners();const A=new c(".popup_type-avatar",(t=>{document.querySelector(".profile__avatar").src=t}),_);A.setEventListeners();document.querySelector(".profile__avatar-edit-button").addEventListener("click",(()=>{A.open()}))})();