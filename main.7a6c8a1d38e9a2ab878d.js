(()=>{"use strict";const e=class{constructor(e,t){this._formElement=t,this._inputSelector=e.inputSelector,this._submitButtonSelector=e.submitButtonSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._inputList=Array.from(this._formElement.querySelectorAll(this._inputSelector)),this._submitButton=this._formElement.querySelector(this._submitButtonSelector)}_showInputError(e,t){const s=this._formElement.querySelector("#".concat(e.id,"-error"));e.classList.add(this._inputErrorClass),s.textContent=t,s.classList.add(this._errorClass)}_hideInputError(e){const t=this._formElement.querySelector("#".concat(e.id,"-error"));e.classList.remove(this._inputErrorClass),t.textContent="",t.classList.remove(this._errorClass)}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?(this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.disabled=!0):(this._submitButton.classList.remove(this._inactiveButtonClass),this._submitButton.disabled=!1)}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))})),this._formElement.addEventListener("submit",(e=>{e.preventDefault()}))}enableValidation(){this._setEventListeners()}resetValidation(){this._inputList.forEach((e=>{this._hideInputError(e)})),this._toggleButtonState()}disableSubmitButton(){this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.disabled=!0}};const t=class{constructor(e){this._popup=document.querySelector(e),this._handleEscClose=this._handleEscClose.bind(this)}_handleEscClose(e){"Escape"===e.key&&this.close()}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}setEventListeners(){this._popup.addEventListener("click",(e=>{(e.target.classList.contains("popup")||e.target.classList.contains("popup__close"))&&this.close()}))}};const s=class extends t{constructor(e,t){super(e),this._submitHandler=t,this._form=this._popup.querySelector(".popup__form"),this._inputs=Array.from(this._form.querySelectorAll(".popup__input")),this._submitButton=this._form.querySelector(".popup__button")}_getInputValues(){const e={};return this._inputs.forEach((t=>{e[t.name]=t.value})),e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this.setSubmitButtonCaption("Сохранение..."),this._submitHandler(this._getInputValues()).then((()=>{this.close()})).catch((e=>{console.error("Ошибка при отправке данных на сервер: ".concat(e))})).finally((()=>{this.setSubmitButtonCaption("Сохранить")}))}))}open(){super.open()}setSubmitButtonCaption(e){this._submitButton.textContent=e}close(){super.close(),this._form.reset()}};const n=class{constructor(e){let{nameSelector:t,bioSelector:s}=e;this._nameElement=document.querySelector(t),this._bioElement=document.querySelector(s),this._id=null}getUserInfo(){return{name:this._nameElement.textContent,bio:this._bioElement.textContent}}setUserInfo(e){e.name&&(this._nameElement.textContent=e.name),e.about&&(this._bioElement.textContent=e.about),e._id&&(this._id=e._id)}getUserId(){return this._id}};const i=class{constructor(e,t){let{items:s,renderer:n}=e;this._items=s,this._renderer=n,this._container=document.querySelector(t)}renderItems(){this._items.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.append(e)}prependItem(e){this._container.prepend(e)}};const r=class{constructor(e){this._baseUrl=e.baseUrl,this._headers=e.headers}_checkResponse(e){return e.ok?e.json():Promise.reject("Ошибка: ".concat(e.status))}getUserInfo(){return fetch("".concat(this._baseUrl,"/users/me"),{headers:this._headers}).then(this._checkResponse)}getInitialCards(){return fetch("".concat(this._baseUrl,"/cards"),{headers:this._headers}).then(this._checkResponse)}editUserInfo(e){return fetch("".concat(this._baseUrl,"/users/me"),{method:"PATCH",headers:this._headers,body:JSON.stringify(e)}).then(this._checkResponse)}addCard(e){return fetch("".concat(this._baseUrl,"/cards"),{method:"POST",headers:this._headers,body:JSON.stringify(e)}).then(this._checkResponse)}deleteCard(e){return fetch("".concat(this._baseUrl,"/cards/").concat(e),{method:"DELETE",headers:this._headers}).then(this._checkResponse)}likeCard(e){return fetch("".concat(this._baseUrl,"/cards/likes/").concat(e),{method:"PUT",headers:this._headers}).then(this._checkResponse)}unlikeCard(e){return fetch("".concat(this._baseUrl,"/cards/likes/").concat(e),{method:"DELETE",headers:this._headers}).then(this._checkResponse)}updateAvatar(e){return fetch("".concat(this._baseUrl,"/users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}};const o=class extends t{constructor(e,t){super(e),this._submitHandler=t,this._deleteButton=this._popup.querySelector(".popup__button_type_delete")}setSubmitAction(e){this._submitHandler=e}setEventListeners(){super.setEventListeners(),this._deleteButton.addEventListener("click",(()=>{this._submitHandler()}))}};const a=class{constructor(e,t,s,n){let{handleCardClick:i,handleCardLike:r,handleCardDelete:o}=n;this._name=e.name,this._link=e.link,this._likes=e.likes,this._ownerId=e.owner._id,this._cardId=e._id,this._currentUserId=s,this._cardSelector=t,this._handleCardClick=i,this._handleCardLike=r,this._handleCardDelete=o}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".element").cloneNode(!0)}_setEventListeners(){this._element.querySelector(".element__like-button").addEventListener("click",(()=>{this._handleCardLike(this._cardId,this._isLiked())})),this._element.querySelector(".element__delete-button").addEventListener("click",(()=>{this._handleCardDelete(this._cardId)})),this._element.querySelector(".element__image").addEventListener("click",(()=>{this._handleCardClick({name:this._name,link:this._link})}))}_isLiked(){return this._likes.some((e=>e._id===this._currentUserId))}updateLikes(e){this._likes=e,this._element.querySelector(".element__like-count").textContent=e.length,this._toggleLike()}_toggleLike(){this._element.querySelector(".element__like-button").classList.toggle("element__like-button_active",this._isLiked())}generateCard(){return this._element=this._getTemplate(),this._setEventListeners(),this._toggleLike(),this._element.querySelector(".element__title").textContent=this._name,this._element.querySelector(".element__image").src=this._link,this._element.querySelector(".element__like-count").textContent=this._likes.length,this._ownerId!==this._currentUserId&&(this._element.querySelector(".element__delete-button").style.display="none"),this._element}};let l,c;const _=localStorage.getItem("avatar");_&&(c=document.querySelector(".profile__avatar"),c.src=_);const h=new r({baseUrl:"https://nomoreparties.co/v1/cohort-75",headers:{authorization:"15456b01-b272-4795-9fed-b0870e9982e9","Content-Type":"application/json"}}),u=document.querySelector(".profile__edit-button"),d=document.querySelector(".profile__add-button"),p=document.querySelector(".popup__form_edit"),m=document.querySelector(".popup__form_add"),b=(document.querySelector(".elements"),document.querySelector(".popup__form_type-avatar")),S=new s(".popup_type-card",(()=>{}));S.setEventListeners();const C={inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},E=new e(C,b);E.enableValidation();const v=new e(C,m);v.enableValidation();const y=new s(".popup_type-add",(e=>{const t=y.getSubmitButtonCaption();y.disableSubmitButton(),h.addCard(e).then((e=>{!function(e){const t=L(e);g.addItem(t)}(e),y.close()})).catch((e=>{console.error("Ошибка при создании карточки: ".concat(e))})).finally((()=>{y.setSubmitButtonCaption(t),y.enableSubmitButton()}))}));y.setEventListeners();const k=new e(C,p);k.enableValidation();const f=new n({nameSelector:".profile__title",bioSelector:".profile__bio",avatarSelector:".profile__avatar"});function L(e){const t=new a(e,"#card-template",l,{handleCardClick:U,handleCardLike:w,handleCardDelete:s=>{!function(e,t){const s=new o(".popup_type-delete",(()=>{h.deleteCard(e).then((()=>{g.removeItem(t),s.close()})).catch((e=>{console.error("Ошибка при удалении карточки: ".concat(e))}))}));s.setEventListeners(),s.open()}(s),e._id,t.toggleLike()}});return t.createCardElement()}const g=new i({items:[],renderer:e=>{const t=L(e);g.addItem(t)}},".elements"),I=p.querySelector(".popup__input_type_name"),B=p.querySelector(".popup__input_type_bio"),q=new s(".popup_type-edit",(e=>{const t=q.getSubmitButtonCaption();q.disableSubmitButton(),h.editUserInfo(e).then((e=>{f.setUserInfo(e)})).catch((e=>{console.error("Ошибка при редактировании профиля: ".concat(e))})).finally((()=>{q.setSubmitButtonCaption(t),q.enableSubmitButton()}))}));function U(e){S.open(e)}function w(e,t){h.likeCard(e,t).then((e=>e)).catch((e=>{throw console.error("Ошибка при постановке/снятии лайка:",e),e}))}q.setEventListeners(),d.addEventListener("click",(()=>{v.resetValidation(),y.open()}));new o(".popup_type-delete",(e=>{h.deleteCard(e).then((()=>{g.removeItem(e)})).catch((e=>{console.error("Ошибка при удалении карточки: ".concat(e))}))})).setEventListeners();const x=new s(".popup_type-avatar",(e=>{c.src=e}),h);x.setEventListeners();document.querySelector(".profile__avatar-edit-button").addEventListener("click",(()=>{E.resetValidation(),x.open()})),u.addEventListener("click",(()=>{!function(){const e=f.getUserInfo();I.value=e.name,B.value=e.bio,k.resetValidation(),q.open()}()}))})();